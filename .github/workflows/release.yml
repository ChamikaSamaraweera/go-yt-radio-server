name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper versioning

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Verify dependencies
        run: |
          go mod download
          go mod verify

      - name: Build for Linux AMD64
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          echo "âš™ï¸ Building for Linux/AMD64..."
          go build -v \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -o radio-server-linux-amd64 \
            main.go
          
          # Verify binary
          file radio-server-linux-amd64
          ls -lh radio-server-linux-amd64

      - name: Build for Linux ARM64
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          echo "âš™ï¸ Building for Linux/ARM64..."
          go build -v \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -o radio-server-linux-arm64 \
            main.go
          
          # Verify binary
          file radio-server-linux-arm64
          ls -lh radio-server-linux-arm64

      - name: Build for Linux ARM (32-bit)
        env:
          GOOS: linux
          GOARCH: arm
          GOARM: 7
          CGO_ENABLED: 0
        run: |
          echo "âš™ï¸ Building for Linux/ARM (32-bit)..."
          go build -v \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -o radio-server-linux-arm \
            main.go
          
          file radio-server-linux-arm
          ls -lh radio-server-linux-arm

      - name: Build for Windows AMD64
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          echo "âš™ï¸ Building for Windows/AMD64..."
          go build -v \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -o radio-server-windows-amd64.exe \
            main.go
          
          ls -lh radio-server-windows-amd64.exe

      - name: Build for macOS AMD64
        env:
          GOOS: darwin
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          echo "âš™ï¸ Building for macOS/AMD64..."
          go build -v \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -o radio-server-darwin-amd64 \
            main.go
          
          ls -lh radio-server-darwin-amd64

      - name: Build for macOS ARM64 (Apple Silicon)
        env:
          GOOS: darwin
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          echo "âš™ï¸ Building for macOS/ARM64..."
          go build -v \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -o radio-server-darwin-arm64 \
            main.go
          
          ls -lh radio-server-darwin-arm64

      - name: Generate checksums
        run: |
          sha256sum radio-server-* > checksums.txt
          cat checksums.txt

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸ“» Go YouTube Radio Server ${{ steps.version.outputs.VERSION }}

          ### ðŸ“¦ Download the appropriate binary for your platform:

          - **Linux ARM64** (Raspberry Pi, Oracle Cloud ARM): `radio-server-linux-arm64`
          - **Linux AMD64** (Standard servers): `radio-server-linux-amd64`
          - **Linux ARM 32-bit** (Older Raspberry Pi): `radio-server-linux-arm`
          - **Windows AMD64**: `radio-server-windows-amd64.exe`
          - **macOS Intel**: `radio-server-darwin-amd64`
          - **macOS Apple Silicon**: `radio-server-darwin-arm64`

          ### âœ… Installation

          ```bash
          # Download binary for your platform
          chmod +x radio-server-*
          ./radio-server-linux-amd64
          ```

          ### ðŸ“‹ Requirements

          - **yt-dlp**: [Install guide](https://github.com/yt-dlp/yt-dlp#installation)
          - **ffmpeg**: Static builds recommended

          ### ðŸ” Verify Download

          Check `checksums.txt` for SHA256 hashes.

          ---

          **Full documentation:** https://github.com/ChamikaSamaraweera/go-yt-radio-server/blob/main/README.md
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            radio-server-linux-amd64
            radio-server-linux-arm64
            radio-server-linux-arm
            radio-server-windows-amd64.exe
            radio-server-darwin-amd64
            radio-server-darwin-arm64
            checksums.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: radio-server-binaries-${{ steps.version.outputs.VERSION }}
          path: |
            radio-server-*
            checksums.txt
          retention-days: 30